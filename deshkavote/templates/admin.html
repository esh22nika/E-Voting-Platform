{% load static %} 
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DeshKaVote - Admin Interface</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>

<nav class="p-3 border-bottom mb-4 bg-light">
  <a href="{% url 'landing' %}" class="me-3">Home</a>
  <a href="{% url 'admin_login' %}">Login</a>
  <a href="{% url 'logout' %}" class="me-3">Logout</a>
</nav>

<header class="text-center my-4">
  <img src="{% static 'images/logo.png' %}" alt="DeshKaVote Logo" class="rounded-circle mb-2" style="width: 100px; height: 100px; object-fit: cover; border: none;">
  <div>DeshKaVote - Admin Interface</div>
  <div class="text-muted">Welcome, {{ admin_username }}</div>
</header>

<main class="container">
  
  <!-- Display success/error messages -->
  <div id="messageContainer" style="display: none;" class="alert alert-dismissible fade show">
    <span id="messageText"></span>
    <button type="button" class="btn-close" onclick="hideMessage()"></button>
  </div>

  <!-- Voter Approval Section -->
  <section aria-labelledby="voter-approval-title" class="my-4 p-4 border rounded">
    <h2 id="voter-approval-title" class="pb-2 mb-4 border-bottom border-warning">
      Voter Approval Management
      <span class="badge bg-warning text-dark ms-2">{{ pending_count }} Pending</span>
    </h2>

    <!-- Approval Tabs -->
    <ul class="nav nav-tabs" id="approvalTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab">
          Pending Approval ({{ pending_count }})
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="approved-tab" data-bs-toggle="tab" data-bs-target="#approved" type="button" role="tab">
          Approved ({{ approved_count }})
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="rejected-tab" data-bs-toggle="tab" data-bs-target="#rejected" type="button" role="tab">
          Rejected ({{ rejected_count }})
        </button>
      </li>
    </ul>

    <div class="tab-content" id="approvalTabContent">
      <!-- Pending Voters Tab -->
      <div class="tab-pane fade show active" id="pending" role="tabpanel">
        <div class="mt-3">
          {% if pending_voters %}
            <div class="table-responsive">
              <table class="table table-bordered table-striped">
                <thead class="table-warning">
                  <tr>
                    <th scope="col">Voter ID</th>
                    <th scope="col">Name</th>
                    <th scope="col">Email</th>
                    <th scope="col">Mobile</th>
                    <th scope="col">State</th>
                    <th scope="col">Registration Date</th>
                    <th scope="col">Action</th>
                  </tr>
                </thead>
                <tbody>
                  {% for voter in pending_voters %}
                  <tr id="voter-row-{{ voter.id }}">
                    <td>{{ voter.voter_id }}</td>
                    <td>{{ voter.full_name }}</td>
                    <td>{{ voter.email }}</td>
                    <td>{{ voter.mobile }}</td>
                    <td>{{ voter.state }}</td>
                    <td>{{ voter.created_at|date:"M d, Y H:i" }}</td>
                    <td>
                      <button class="btn btn-success btn-sm me-2" onclick="approveVoter('{{ voter.id }}', '{{ voter.voter_id }}')">
                        Approve
                      </button>
                      <button class="btn btn-danger btn-sm" onclick="showRejectModal('{{ voter.id }}', '{{ voter.voter_id }}')">
                        Reject
                      </button>
                      <button class="btn btn-info btn-sm ms-2" onclick="viewVoterDetails('{{ voter.id }}')">
                        View Details
                      </button>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="alert alert-info">No pending voter approvals.</div>
          {% endif %}
        </div>
      </div>

      <!-- Approved Voters Tab -->
      <div class="tab-pane fade" id="approved" role="tabpanel">
        <div class="mt-3">
          {% if approved_voters %}
            <div class="table-responsive">
              <table class="table table-bordered table-striped">
                <thead class="table-success">
                  <tr>
                    <th scope="col">Voter ID</th>
                    <th scope="col">Name</th>
                    <th scope="col">Email</th>
                    <th scope="col">State</th>
                    <th scope="col">Approved Date</th>
                    <th scope="col">Approved By</th>
                  </tr>
                </thead>
                <tbody>
                  {% for voter in approved_voters %}
                  <tr>
                    <td>{{ voter.voter_id }}</td>
                    <td>{{ voter.full_name }}</td>
                    <td>{{ voter.email }}</td>
                    <td>{{ voter.state }}</td>
                    <td>{{ voter.approval_date|date:"M d, Y H:i" }}</td>
                    <td>{{ voter.approved_by.username|default:"N/A" }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="alert alert-info">No approved voters yet.</div>
          {% endif %}
        </div>
      </div>

      <!-- Rejected Voters Tab -->
      <div class="tab-pane fade" id="rejected" role="tabpanel">
        <div class="mt-3">
          {% if rejected_voters %}
            <div class="table-responsive">
              <table class="table table-bordered table-striped">
                <thead class="table-danger">
                  <tr>
                    <th scope="col">Voter ID</th>
                    <th scope="col">Name</th>
                    <th scope="col">Email</th>
                    <th scope="col">State</th>
                    <th scope="col">Rejection Date</th>
                    <th scope="col">Reason</th>
                  </tr>
                </thead>
                <tbody>
                  {% for voter in rejected_voters %}
                  <tr>
                    <td>{{ voter.voter_id }}</td>
                    <td>{{ voter.full_name }}</td>
                    <td>{{ voter.email }}</td>
                    <td>{{ voter.state }}</td>
                    <td>{{ voter.updated_at|date:"M d, Y H:i" }}</td>
                    <td>{{ voter.rejection_reason|default:"No reason provided" }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="alert alert-info">No rejected voters.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </section>

  <!-- Add Candidates -->
  <section aria-labelledby="add-candidate-title" class="my-4 p-4 border rounded">
    <h2 id="add-candidate-title" class="pb-2 mb-4 border-bottom border-warning">Add Candidate</h2>
    <form aria-label="Add candidate form" onsubmit="return false;">
      <div class="mb-3">
        <label for="candidateName" class="form-label fw-bold">Candidate Name</label>
        <input type="text" id="candidateName" name="candidateName" class="form-control" placeholder="Enter candidate full name" required />
      </div>
      <div class="mb-3">
        <label for="candidateParty" class="form-label fw-bold">Party</label>
        <select id="candidateParty" name="candidateParty" class="form-select" required>
          <option value="" disabled selected>Select party</option>
          <option value="BJP">BJP</option>
          <option value="Congress">Congress</option>
          <option value="AAP">AAP</option>
          <option value="Left Front">Left Front</option>
          <option value="Independent">Independent</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="candidateConstituency" class="form-label fw-bold">Constituency / Ward</label>
        <input type="text" id="candidateConstituency" name="candidateConstituency" class="form-control" placeholder="Enter constituency or ward" required />
      </div>
      <div class="mb-3">
        <label for="candidateSymbol" class="form-label fw-bold">Party Symbol</label>
        <input type="text" id="candidateSymbol" name="candidateSymbol" class="form-control" placeholder="Enter symbol name" required />
      </div>
      <div class="mb-3">
        <label for="candidateEducation" class="form-label fw-bold">Education</label>
        <input type="text" id="candidateEducation" name="candidateEducation" class="form-control" placeholder="e.g., PhD in Political Science" />
      </div>
      <button type="submit" class="btn btn-primary">Add Candidate</button>
    </form>
  </section>

  <!-- Create Election -->
  <section aria-labelledby="create-election-title" class="my-4 p-4 border rounded">
    <h2 id="create-election-title" class="pb-2 mb-4 border-bottom border-warning">Create Election</h2>
    <form aria-label="Create election form" onsubmit="return false;">
      <div class="mb-3">
        <label for="electionState" class="form-label fw-bold">State</label>
        <select id="electionState" name="electionState" class="form-select" required>
          <option value="" disabled selected>Select State</option>
          <option value="Uttar Pradesh">Uttar Pradesh</option>
          <option value="Delhi">Delhi</option>
          <option value="Bihar">Bihar</option>
          <option value="Maharashtra">Maharashtra</option>
          <option value="West Bengal">West Bengal</option>
          <option value="Tamil Nadu">Tamil Nadu</option>
          <option value="Karnataka">Karnataka</option>
          <option value="Gujarat">Gujarat</option>
          <option value="Rajasthan">Rajasthan</option>
          <option value="Madhya Pradesh">Madhya Pradesh</option>
          <option value="Kerala">Kerala</option>
          <option value="Punjab">Punjab</option>
          <option value="Haryana">Haryana</option>
          <option value="Odisha">Odisha</option>
          <option value="Andhra Pradesh">Andhra Pradesh</option>
          <option value="Telangana">Telangana</option>
          <option value="Assam">Assam</option>
          <option value="Chhattisgarh">Chhattisgarh</option>
          <option value="Jharkhand">Jharkhand</option>
          <option value="Uttarakhand">Uttarakhand</option>
          <option value="Himachal Pradesh">Himachal Pradesh</option>
          <option value="Goa">Goa</option>
          <option value="Meghalaya">Meghalaya</option>
          <option value="Manipur">Manipur</option>
          <option value="Mizoram">Mizoram</option>
          <option value="Nagaland">Nagaland</option>
          <option value="Sikkim">Sikkim</option>
          <option value="Tripura">Tripura</option>
          <option value="Arunachal Pradesh">Arunachal Pradesh</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="electionType" class="form-label fw-bold">Election Type</label>
        <select id="electionType" name="electionType" class="form-select" required>
          <option value="" disabled selected>Select Election Type</option>
          <option value="General Election">General Election</option>
          <option value="State Assembly">State Assembly</option>
          <option value="Municipal">Municipal</option>
          <option value="Panchayat">Panchayat</option>
          <option value="By-Election">By-Election</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="electionYear" class="form-label fw-bold">Year</label>
        <select id="electionYear" name="electionYear" class="form-select" required>
          <option value="" disabled selected>Select Year</option>
          <script>
            const currentYear = new Date().getFullYear();
            for (let i = currentYear - 5; i <= currentYear + 5; i++) {
              document.write(`<option value="${i}">${i}</option>`);
            }
          </script>
        </select>
      </div>
      <div class="mb-3">
        <label for="electionName" class="form-label fw-bold">Election Name</label>
        <input type="text" id="electionName" name="electionName" class="form-control" placeholder="Enter election name (e.g., General Election 2024)" required />
      </div>
      <div class="mb-3">
        <label for="startDate" class="form-label fw-bold">Start Date & Time</label>
        <input type="datetime-local" id="startDate" name="startDate" class="form-control" required />
      </div>
      <div class="mb-3">
        <label for="endDate" class="form-label fw-bold">End Date & Time</label>
        <input type="datetime-local" id="endDate" name="endDate" class="form-control" required />
      </div>
      <button type="submit" class="btn btn-primary">Create Election</button>
    </form>
  </section>

  <!-- Download Voter Lists -->
  <section aria-labelledby="download-voters-title" class="my-4 p-4 border rounded">
    <h2 id="download-voters-title" class="pb-2 mb-4 border-bottom border-warning">Download Voter Lists</h2>
    <form aria-label="Download voter lists form" onsubmit="return false;">
      <div class="mb-3">
        <label for="downloadRegion" class="form-label fw-bold">Select Region</label>
        <select id="downloadRegion" name="downloadRegion" class="form-select">
          <option value="all">All Regions</option>
          <option value="Uttar Pradesh">Uttar Pradesh</option>
          <option value="Delhi">Delhi</option>
          <option value="Bihar">Bihar</option>
          <option value="Maharashtra">Maharashtra</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="downloadStatus" class="form-label fw-bold">Voter Status</label>
        <select id="downloadStatus" name="downloadStatus" class="form-select">
          <option value="all">All Registered Voters</option>
          <option value="voted">Voted</option>
          <option value="notVoted">Not Voted</option>
        </select>
      </div>
      <button type="submit" class="btn btn-primary">Download List</button>
    </form>
  </section>
</main>

<!-- Rejection Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="rejectModalLabel">Reject Voter</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to reject voter <strong id="rejectVoterName"></strong>?</p>
        <div class="mb-3">
          <label for="rejectionReason" class="form-label">Reason for rejection (optional)</label>
          <textarea class="form-control" id="rejectionReason" rows="3" placeholder="Enter reason for rejection..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmRejectBtn">Reject Voter</button>
      </div>
    </div>
  </div>
</div>

<!-- Voter Details Modal -->
<div class="modal fade" id="voterDetailsModal" tabindex="-1" aria-labelledby="voterDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="voterDetailsModalLabel">Voter Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="voterDetailsContent">
        <!-- Voter details will be loaded here -->
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Global variables for voter approval
let pendingRejectVoterId = null;
let pendingRejectVoterName = null;

// Function to show success message
function showMessage(message, type = 'success') {
  const container = document.getElementById('messageContainer');
  const messageText = document.getElementById('messageText');
  
  container.className = `alert alert-${type} alert-dismissible fade show`;
  messageText.textContent = message;
  container.style.display = 'block';
  
  // Auto-hide after 5 seconds
  setTimeout(hideMessage, 5000);
}

// Function to hide message
function hideMessage() {
  const container = document.getElementById('messageContainer');
  container.style.display = 'none';
}

// Function to get CSRF token
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

// Function to approve a voter
async function approveVoter(voterId, voterIdString) {
  try {
    const response = await fetch('/api/approve-voter/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        voter_id: voterId,
        action: 'approve'
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      showMessage(result.message, 'success');
      // Remove the row from pending table
      const row = document.getElementById(`voter-row-${voterId}`);
      if (row) {
        row.remove();
      }
      // Update badge counts
      updateBadgeCounts();
    } else {
      showMessage(result.message, 'danger');
    }
  } catch (error) {
    console.error('Error approving voter:', error);
    showMessage('Error approving voter. Please try again.', 'danger');
  }
}

// Function to show reject modal
function showRejectModal(voterId, voterIdString) {
  pendingRejectVoterId = voterId;
  pendingRejectVoterName = voterIdString;
  
  document.getElementById('rejectVoterName').textContent = voterIdString;
  document.getElementById('rejectionReason').value = '';
  
  const modal = new bootstrap.Modal(document.getElementById('rejectModal'));
  modal.show();
}

// Function to reject a voter
async function rejectVoter() {
  const reason = document.getElementById('rejectionReason').value;
  
  try {
    const response = await fetch('/api/approve-voter/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        voter_id: pendingRejectVoterId,
        action: 'reject',
        rejection_reason: reason
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      showMessage(result.message, 'success');
      // Remove the row from pending table
      const row = document.getElementById(`voter-row-${pendingRejectVoterId}`);
      if (row) {
        row.remove();
      }
      // Hide modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('rejectModal'));
      modal.hide();
      // Update badge counts
      updateBadgeCounts();
    } else {
      showMessage(result.message, 'danger');
    }
  } catch (error) {
    console.error('Error rejecting voter:', error);
    showMessage('Error rejecting voter. Please try again.', 'danger');
  }
}

// Function to update badge counts
function updateBadgeCounts() {
  // Count remaining pending voters
  const pendingRows = document.querySelectorAll('#pending tbody tr');
  const pendingCount = pendingRows.length;
  
  // Update the badge in the tab
  const pendingTab = document.getElementById('pending-tab');
  if (pendingTab) {
    pendingTab.innerHTML = `Pending Approval (${pendingCount})`;
  }
  
  // Update the main header badge
  const headerBadge = document.querySelector('#voter-approval-title .badge');
  if (headerBadge) {
    headerBadge.textContent = `${pendingCount} Pending`;
  }
}

// Function to view voter details (placeholder)
function viewVoterDetails(voterId) {
  // This would fetch and display detailed voter information
  // For now, just show a placeholder
  const modal = new bootstrap.Modal(document.getElementById('voterDetailsModal'));
  const content = document.getElementById('voterDetailsContent');
  content.innerHTML = `
    <div class="text-center">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">Loading voter details...</p>
    </div>
  `;
  modal.show();
  
  // Simulate loading
  setTimeout(() => {
    content.innerHTML = `
      <div class="alert alert-info">
        <strong>Feature coming soon!</strong> Detailed voter information view will be implemented.
      </div>
    `;
  }, 1000);
}

// Event listener for reject confirmation button
document.getElementById('confirmRejectBtn').addEventListener('click', rejectVoter);

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  console.log('Admin dashboard loaded');
  
  // Any additional initialization can go here
});
</script>
</body>
</html>
